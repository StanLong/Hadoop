- 

#### 分区表

Hive 中的分区就是分目录，在WHERE条件里用分区字段筛选，可以提高查询效率。 注意分区字段不能和表里已有的字段一样，不然会报错 Column repeated in partitioning columns。

##### 建分区表

```sql
# 按 pt_d 为分区字段创建员工表, 分区字段任意
create external table if not exists emp(
    empno       int
   ,ename       string
   ,job         string
   ,mgr         int
   ,hiredate    string
   ,sal         double
   ,comm        double
   ,deptno      int
)
partitioned by (pt_d int)
row format delimited fields terminated by '\t';
```

##### 添加分区

```sql
alter table emp add partition(pt_d='20210129');
```

![](D:/StanLong/git_repository/Hadoop/05Hive/doc/05.png)

同时给表添加多个分区

```sql
alter table emp add partition(pt_d='20210127') partition(pt_d='20210128');
```

##### 删除分区

```sql
alter table emp drop partition(pt_d='20210129');
```

删除多个分区

```sql
alter table emp drop partition(pt_d='20210127'),partition(pt_d='20210128');
alter table emp drop partition (pt_d>='20210127',pt_d<='20210128')
```

##### 查看分区

```sql
show partitions emp;
```

##### 多级分区

```sql
create external table if not exists ods_emp
(
   empno       int
   ,ename       string
   ,job         string
   ,mgr         int
   ,hiredate    string
   ,sal         double
   ,comm        double
   ,deptno      int
)
partitioned by (pt_m String, pt_d String)
row format delimited fields terminated by '\t';
```

##### 修复分区

```sql
msck repair table emp;
```

#### 分桶表

分区针对的是数据的存储路径；分桶针对的是数据文件。

分区会增加一个分区字段，分桶是对表里的数据进行分桶，需要指明分桶的个数

分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区。

分桶是将数据集分解成更容易管理的若干部分的另一个技术。

**要使分桶表生效，必须把普通表的数据倒数到分桶表中**

新建一张普通表，表字段和分桶表一样，并导入数据

```sql
create table stu_shadow
(
    id int
   ,name string
)
row format delimited fields terminated by '\t';
hdfs dfs -put stu.txt /user/hivedb/warehouse/stu_shadow
```

##### 建分桶表

```sql
create table stu_buck
(
    id int
   ,name string
)
clustered by(id) into 4 buckets
row format delimited fields terminated by '\t';
```

##### 设置分桶属性

```sql
set hive.enforce.bucketing=true;
set mapreduce.job.reduces=-1;
```

##### 导入普通表的数据到分桶表

```sql
insert into table stu_buck select id, name from stu_shadow;
```

##### 查看分桶

```sql
hive> select * from stu_buck;
+--------------+----------------+--+
| stu_buck.id  | stu_buck.name  |
+--------------+----------------+--+
| 1016         | ss16           |
| 1012         | ss12           |
| 1008         | ss8            |
| 1004         | ss4            |
| 1009         | ss9            |
| 1005         | ss5            |
| 1001         | ss1            |
| 1013         | ss13           |
| 1010         | ss10           |
| 1002         | ss2            |
| 1006         | ss6            |
| 1014         | ss14           |
| 1003         | ss3            |
| 1011         | ss11           |
| 1007         | ss7            |
| 1015         | ss15           |
+--------------+----------------+--+
# 观察id可以发现 1到4行对4取余为0，5到8行对4取余为1，9到12行对4取余为2，13到16行对四取余为3
```

![](D:/StanLong/git_repository/Hadoop/05Hive/doc/06.png)



##### 分桶抽样查询

对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。Hive可以通过对表进行抽样来满足这个需求。

分桶查询表stu_buck中的数据

```sql
hive> select * from stu_buck tablesample(bucket 1 out of 4 on id);
+--------------+----------------+--+
| stu_buck.id  | stu_buck.name  |
+--------------+----------------+--+
| 1016         | ss16           |
| 1012         | ss12           |
| 1008         | ss8            |
| 1004         | ss4            |
+--------------+----------------+--+
4 rows selected (1.924 seconds)
hive> select * from stu_buck tablesample(bucket 1 out of 8 on id);
+--------------+----------------+--+
| stu_buck.id  | stu_buck.name  |
+--------------+----------------+--+
| 1016         | ss16           |
| 1008         | ss8            |
+--------------+----------------+--+
2 rows selected (0.268 seconds)
```

注：tablesample是抽样语句，语法：TABLESAMPLE(BUCKET x OUT OF y) 。

y必须是table总bucket数的倍数或者因子。hive根据y的大小，决定抽样的比例。例如，table总共分了4份，当y=4时，抽取(4/4=)1个bucket的数据，当y=8时，抽取(4/8=)1/2个bucket的数据。

x表示从哪个bucket开始抽取，如果需要取多个分区，以后的分区号为当前分区号加上y。例如，table总bucket数为4，tablesample(bucket 1 out of 2)，表示总共抽取（4/2=）2个bucket的数据，抽取第1(x)个和第3(x+y)个bucket的数据。

注意：x的值必须小于等于y的值，否则

FAILED: SemanticException [Error 10061]: Numerator should not be bigger than denominator in sample clause for table stu_buck